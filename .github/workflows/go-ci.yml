name: Go CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  GO_VERSION: '1.21'

jobs:
  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      - name: Download dependencies
        working-directory: go
        run: go mod download

      - name: Run tests (without CGO)
        working-directory: go
        env:
          CGO_ENABLED: 0
        run: go test ./... -v

      - name: Build (without CGO)
        working-directory: go
        env:
          CGO_ENABLED: 0
        run: go build ./cmd/coinjectured

  test-with-cgo:
    name: Test Suite with CGO (Rust Integration)
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install MinGW (Windows only)
        if: runner.os == 'Windows'
        run: |
          choco install mingw

      - name: Build Rust library
        working-directory: rust/coinjecture-core
        run: cargo build --release --features ffi

      - name: Set library path (Linux)
        if: runner.os == 'Linux'
        run: echo "LD_LIBRARY_PATH=${{ github.workspace }}/rust/coinjecture-core/target/release:$LD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Set library path (macOS)
        if: runner.os == 'macOS'
        run: echo "DYLD_LIBRARY_PATH=${{ github.workspace }}/rust/coinjecture-core/target/release:$DYLD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Set library path (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $rustPath = "${{ github.workspace }}\rust\coinjecture-core\target\release"
          echo "PATH=$rustPath;$env:PATH" >> $env:GITHUB_ENV

      - name: Test Go consensus bindings with CGO
        working-directory: go
        env:
          CGO_ENABLED: 1
        run: go test ./pkg/consensus -v

      - name: Build daemon with CGO
        working-directory: go
        env:
          CGO_ENABLED: 1
        run: go build ./cmd/coinjectured

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          working-directory: go
          args: --timeout=5m

  fmt:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Check formatting
        working-directory: go
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "Go code is not formatted:"
            gofmt -d .
            exit 1
          fi

  vet:
    name: Go Vet
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run go vet
        working-directory: go
        run: go vet ./...

  build-binaries:
    name: Build Release Binaries
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            artifact_name: coinjectured-linux-amd64
          - os: windows-latest
            goos: windows
            goarch: amd64
            artifact_name: coinjectured-windows-amd64.exe
          - os: macos-latest
            goos: darwin
            goarch: amd64
            artifact_name: coinjectured-darwin-amd64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build binary
        working-directory: go
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: go build -o ${{ matrix.artifact_name }} ./cmd/coinjectured

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: go/${{ matrix.artifact_name }}
          retention-days: 30
